<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Setup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #0f172a; color: #e2e8f0; min-height: 100vh; display: flex; }
    .sidebar { width: 220px; background: #1a1a2e; height: 100vh; position: fixed; display: flex; flex-direction: column; border-right: 1px solid rgba(255,255,255,0.06); overflow-y: auto; }
    .sidebar-header { padding: 24px 20px 16px; border-bottom: 1px solid rgba(255,255,255,0.08); display: flex; align-items: center; gap: 10px; }
    .sidebar-header i { color: #4361ee; font-size: 1.2rem; }
    .sidebar-header span { font-weight: 700; letter-spacing: 2px; font-size: 0.9rem; color: #fff; }
    .nav-section-label { padding: 16px 20px 4px; font-size: 0.65rem; font-weight: 700; color: rgba(255,255,255,0.25); text-transform: uppercase; letter-spacing: 1.5px; display: block; }
    .nav-list { list-style: none; padding: 8px 0; flex: 1; }
    .nav-link { display: flex; align-items: center; gap: 10px; padding: 10px 20px; color: rgba(255,255,255,0.55); text-decoration: none; font-size: 0.85rem; border-left: 3px solid transparent; transition: all 0.2s; }
    .nav-link:hover { background: rgba(255,255,255,0.05); color: #fff; border-left-color: rgba(67,97,238,0.4); }
    .nav-link.active { background: rgba(67,97,238,0.15); color: #fff; border-left-color: #4361ee; font-weight: 600; }
    .nav-link.active i { color: #4361ee; }
    .nav-link i { width: 16px; text-align: center; }
    .nav-divider { height: 1px; background: rgba(255,255,255,0.06); margin: 6px 16px; }
    .sidebar-footer { border-top: 1px solid rgba(255,255,255,0.07); padding: 10px 0; }
    .nav-link.danger:hover { background: rgba(230,57,70,0.1); color: #e63946; border-left-color: #e63946; }
    .main { margin-left: 220px; flex: 1; padding: 36px 40px; min-height: 100vh; }
    .page-header { margin-bottom: 28px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px; }
    .page-header h1 { font-size: 1.5rem; font-weight: 700; color: #f1f5f9; }
    .page-header p { color: rgba(255,255,255,0.4); font-size: 0.85rem; margin-top: 4px; }
    .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 28px; }
    .stat-card { background: #1e293b; border: 1px solid rgba(255,255,255,0.07); border-radius: 14px; padding: 20px; display: flex; align-items: center; gap: 14px; transition: transform 0.2s; }
    .stat-card:hover { transform: translateY(-2px); }
    .stat-icon { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; flex-shrink: 0; }
    .stat-icon.blue { background: rgba(67,97,238,0.15); color: #4361ee; }
    .stat-icon.green { background: rgba(16,185,129,0.15); color: #10b981; }
    .stat-icon.amber { background: rgba(245,158,11,0.15); color: #f59e0b; }
    .stat-icon.red { background: rgba(239,68,68,0.15); color: #ef4444; }
    .stat-val { font-size: 1.5rem; font-weight: 700; color: #f1f5f9; }
    .stat-label { font-size: 0.75rem; color: rgba(255,255,255,0.4); margin-top: 2px; }
    .tab-bar { display: flex; gap: 4px; margin-bottom: 24px; background: rgba(255,255,255,0.04); padding: 5px; border-radius: 12px; width: fit-content; flex-wrap: wrap; }
    .tab-btn { padding: 8px 16px; border: none; border-radius: 8px; background: transparent; color: rgba(255,255,255,0.45); font-size: 0.82rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; white-space: nowrap; }
    .tab-btn:hover { color: #fff; background: rgba(255,255,255,0.06); }
    .tab-btn.active { background: #4361ee; color: #fff; box-shadow: 0 4px 12px rgba(67,97,238,0.4); }
    .panel { display: none; animation: fadeIn 0.3s ease; }
    .panel.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    .card { background: #1e293b; border: 1px solid rgba(255,255,255,0.07); border-radius: 16px; padding: 28px; max-width: 540px; }
    .card-wide { max-width: 100%; }
    .card-title { font-size: 1rem; font-weight: 700; color: #f1f5f9; margin-bottom: 4px; display: flex; align-items: center; gap: 10px; }
    .card-title i { color: #4361ee; }
    .card-subtitle { font-size: 0.8rem; color: rgba(255,255,255,0.35); margin-bottom: 24px; }
    .field { margin-bottom: 18px; }
    .field label { display: block; font-size: 0.75rem; font-weight: 600; color: rgba(255,255,255,0.45); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 7px; }
    .field input, .field select, .field textarea { width: 100%; padding: 11px 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: #f1f5f9; font-size: 0.9rem; transition: all 0.2s; outline: none; font-family: inherit; }
    .field input::placeholder, .field textarea::placeholder { color: rgba(255,255,255,0.2); }
    .field input:focus, .field select:focus, .field textarea:focus { border-color: #4361ee; background: rgba(67,97,238,0.08); box-shadow: 0 0 0 3px rgba(67,97,238,0.15); }
    .field select option { background: #1e293b; }
    .field-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .role-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 18px; }
    .role-card { padding: 14px 10px; border: 2px solid rgba(255,255,255,0.08); border-radius: 10px; text-align: center; cursor: pointer; transition: all 0.2s; background: rgba(255,255,255,0.03); }
    .role-card:hover { border-color: rgba(67,97,238,0.4); background: rgba(67,97,238,0.06); }
    .role-card.selected { border-color: #4361ee; background: rgba(67,97,238,0.15); }
    .role-card i { font-size: 1.3rem; display: block; margin-bottom: 6px; }
    .role-card span { font-size: 0.78rem; font-weight: 600; color: rgba(255,255,255,0.6); }
    .role-card.selected span { color: #fff; }
    .role-card[data-role="admin"] i { color: #f59e0b; }
    .role-card[data-role="manager"] i { color: #4361ee; }
    .role-card[data-role="staff"] i { color: #10b981; }
    .submit-btn { width: 100%; padding: 12px; background: #4361ee; color: #fff; font-weight: 700; font-size: 0.9rem; border: none; border-radius: 10px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 6px; }
    .submit-btn:hover { background: #3451d1; box-shadow: 0 6px 20px rgba(67,97,238,0.4); transform: translateY(-1px); }
    .submit-btn:active { transform: translateY(0); }
    .submit-btn:disabled { background: #334155; color: rgba(255,255,255,0.3); cursor: not-allowed; transform: none; box-shadow: none; }
    .btn-danger { background: rgba(239,68,68,0.15); color: #ef4444; border: 1px solid rgba(239,68,68,0.3); padding: 7px 14px; border-radius: 8px; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .btn-danger:hover { background: rgba(239,68,68,0.25); }
    .btn-sm { padding: 6px 12px; border-radius: 7px; font-size: 0.78rem; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s; }
    .btn-edit { background: rgba(67,97,238,0.15); color: #818cf8; }
    .btn-edit:hover { background: rgba(67,97,238,0.25); }
    .btn-del { background: rgba(239,68,68,0.12); color: #f87171; }
    .btn-del:hover { background: rgba(239,68,68,0.22); }
    .msg-box { margin-top: 14px; padding: 11px 14px; border-radius: 10px; font-size: 0.83rem; font-weight: 600; display: none; align-items: center; gap: 8px; }
    .msg-box.show { display: flex; }
    .msg-box.success { background: rgba(21,128,61,0.15); border: 1px solid rgba(21,128,61,0.3); color: #4ade80; }
    .msg-box.error { background: rgba(185,28,28,0.15); border: 1px solid rgba(185,28,28,0.3); color: #f87171; }
    .msg-box.loading { background: rgba(67,97,238,0.1); border: 1px solid rgba(67,97,238,0.2); color: #818cf8; }
    .data-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    .data-table th { padding: 10px 14px; text-align: left; font-size: 0.72rem; font-weight: 700; color: rgba(255,255,255,0.35); text-transform: uppercase; letter-spacing: 0.8px; border-bottom: 1px solid rgba(255,255,255,0.07); }
    .data-table td { padding: 12px 14px; border-bottom: 1px solid rgba(255,255,255,0.05); color: #cbd5e1; vertical-align: middle; }
    .data-table tr:hover td { background: rgba(255,255,255,0.03); }
    .data-table tr:last-child td { border-bottom: none; }
    .badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 20px; font-size: 0.72rem; font-weight: 700; }
    .badge-admin { background: rgba(245,158,11,0.15); color: #f59e0b; }
    .badge-manager { background: rgba(67,97,238,0.15); color: #818cf8; }
    .badge-staff { background: rgba(16,185,129,0.15); color: #10b981; }
    .badge-active { background: rgba(16,185,129,0.15); color: #10b981; }
    .badge-inactive { background: rgba(239,68,68,0.12); color: #f87171; }
    .search-bar { display: flex; gap: 10px; margin-bottom: 18px; align-items: center; }
    .search-bar input { flex: 1; padding: 10px 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: #f1f5f9; font-size: 0.88rem; outline: none; }
    .search-bar input:focus { border-color: #4361ee; }
    .search-bar input::placeholder { color: rgba(255,255,255,0.2); }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
    .modal-overlay.show { display: flex; }
    .modal { background: #1e293b; border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 28px; width: 100%; max-width: 440px; animation: fadeIn 0.2s ease; }
    .modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
    .modal-title { font-size: 1rem; font-weight: 700; color: #f1f5f9; }
    .modal-close { background: none; border: none; color: rgba(255,255,255,0.4); font-size: 1.2rem; cursor: pointer; padding: 4px; }
    .modal-close:hover { color: #fff; }
    .modal-footer { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }
    .btn-cancel { padding: 10px 20px; background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.6); border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.88rem; }
    .btn-cancel:hover { background: rgba(255,255,255,0.1); color: #fff; }
    .btn-confirm { padding: 10px 20px; background: #4361ee; color: #fff; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 0.88rem; }
    .btn-confirm:hover { background: #3451d1; }
    .btn-confirm.red { background: #ef4444; }
    .btn-confirm.red:hover { background: #dc2626; }
    .empty-state { text-align: center; padding: 48px 20px; color: rgba(255,255,255,0.25); }
    .empty-state i { font-size: 2.5rem; margin-bottom: 12px; display: block; }
    .empty-state p { font-size: 0.88rem; }
    .spinner { width: 15px; height: 15px; border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.7s linear infinite; display: none; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .toggle-wrap { display: flex; align-items: center; gap: 10px; }
    .toggle { position: relative; width: 40px; height: 22px; }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .toggle-slider { position: absolute; inset: 0; background: rgba(255,255,255,0.1); border-radius: 22px; cursor: pointer; transition: 0.3s; }
    .toggle-slider:before { content: ""; position: absolute; width: 16px; height: 16px; left: 3px; bottom: 3px; background: #fff; border-radius: 50%; transition: 0.3s; }
    .toggle input:checked + .toggle-slider { background: #4361ee; }
    .toggle input:checked + .toggle-slider:before { transform: translateX(18px); }
    .back-btn { position: fixed; bottom: 24px; left: 230px; width: 42px; height: 42px; background: #4361ee; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; text-decoration: none; box-shadow: 0 4px 14px rgba(67,97,238,0.4); transition: all 0.2s; font-size: 0.95rem; z-index: 999; }
    .back-btn:hover { transform: scale(1.1); background: #3451d1; }
    .pw-strength { height: 4px; border-radius: 4px; margin-top: 6px; transition: all 0.3s; background: rgba(255,255,255,0.08); }
    .pw-strength.weak { background: #ef4444; width: 33%; }
    .pw-strength.medium { background: #f59e0b; width: 66%; }
    .pw-strength.strong { background: #10b981; width: 100%; }
    .pw-hint { font-size: 0.72rem; color: rgba(255,255,255,0.3); margin-top: 4px; }
    @media (max-width: 900px) { .stats-row { grid-template-columns: repeat(2,1fr); } }
    @media (max-width: 768px) { .sidebar { display: none; } .main { margin-left: 0; padding: 20px; } .back-btn { left: 16px; } .stats-row { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 480px) { .stats-row { grid-template-columns: 1fr; } .field-row { grid-template-columns: 1fr; } }
  </style>
</head>
<body>

<nav class="sidebar">
  <div class="sidebar-header">
    <i class="fas fa-chart-line"></i>
    <span>Records</span>
  </div>
  <ul class="nav-list">
    <li><span class="nav-section-label">Main</span></li>
    <li><a href="home.html" class="nav-link"><i class="fas fa-home"></i> Dashboard</a></li>
    <div class="nav-divider"></div>
    <li><span class="nav-section-label">Finance</span></li>
    <li><a href="financial.html" class="nav-link"><i class="fas fa-cash-register"></i> Sales</a></li>
    <li><a href="pay.html" class="nav-link"><i class="fas fa-credit-card"></i> Make Payment</a></li>
    <div class="nav-divider"></div>
    <li><span class="nav-section-label">Orders</span></li>
    <li><a href="order_history.html" class="nav-link"><i class="fas fa-history"></i> Order Record</a></li>
    <li><a href="my_orders.html" class="nav-link"><i class="fas fa-box"></i> My Orders</a></li>
    <li><a href="admin_approvals.html" class="nav-link"><i class="fas fa-check-circle"></i> Approvals</a></li>
    <div class="nav-divider"></div>
    <li><span class="nav-section-label">Reports</span></li>
    <li><a href="item_history.html" class="nav-link"><i class="fas fa-file-invoice-dollar"></i> Item Reports</a></li>
    <li><a href="low_stock_alert.html" class="nav-link"><i class="fas fa-exclamation-triangle"></i> Low Stock</a></li>
    <div class="nav-divider"></div>
    <li><span class="nav-section-label">Admin</span></li>
    <li><a href="admin_setup.html" class="nav-link active"><i class="fas fa-cog"></i> Admin Setup</a></li>
  </ul>
  <div class="sidebar-footer">
    <ul class="nav-list">
      <li><a href="login.html" class="nav-link danger"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
    </ul>
  </div>
</nav>

<div class="main">
  <div class="page-header">
    <div>
      <h1><i class="fas fa-cog" style="color:#4361ee;margin-right:10px;"></i>Admin Setup</h1>
      <p>Manage departments, projects, users and system settings.</p>
    </div>
  </div>

  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-icon blue"><i class="fas fa-users"></i></div>
      <div><div class="stat-val" id="stat-users">‚Äî</div><div class="stat-label">Total Users</div></div>
    </div>
    <div class="stat-card">
      <div class="stat-icon green"><i class="fas fa-building"></i></div>
      <div><div class="stat-val" id="stat-depts">‚Äî</div><div class="stat-label">Departments</div></div>
    </div>
    <div class="stat-card">
      <div class="stat-icon amber"><i class="fas fa-project-diagram"></i></div>
      <div><div class="stat-val" id="stat-projects">‚Äî</div><div class="stat-label">Projects</div></div>
    </div>
    <div class="stat-card">
      <div class="stat-icon red"><i class="fas fa-shield-alt"></i></div>
      <div><div class="stat-val" id="stat-admins">‚Äî</div><div class="stat-label">Admins</div></div>
    </div>
  </div>

  <div class="tab-bar">
    <button class="tab-btn active" onclick="switchTab('dept',this)"><i class="fas fa-building"></i> Departments</button>
    <button class="tab-btn" onclick="switchTab('project',this)"><i class="fas fa-project-diagram"></i> Projects</button>
    <button class="tab-btn" onclick="switchTab('user',this)"><i class="fas fa-user-plus"></i> Add User</button>
    <button class="tab-btn" onclick="switchTab('users-list',this)"><i class="fas fa-users"></i> Manage Users</button>
    <button class="tab-btn" onclick="switchTab('dept-list',this)"><i class="fas fa-list"></i> Dept. List</button>
    <button class="tab-btn" onclick="switchTab('proj-list',this)"><i class="fas fa-tasks"></i> Project List</button>
    <button class="tab-btn" onclick="switchTab('settings',this)"><i class="fas fa-sliders-h"></i> Settings</button>
  </div>

  <!-- DEPT PANEL -->
  <div class="panel active" id="panel-dept">
    <div class="card">
      <div class="card-title"><i class="fas fa-building"></i> New Department</div>
      <div class="card-subtitle">Create a new department that users and orders can be assigned to.</div>
      <form id="departmentForm">
        <div class="field"><label>Department Name</label><input type="text" id="departmentName" placeholder="e.g. Finance, Procurement..." required /></div>
        <div class="field"><label>Description (optional)</label><textarea id="deptDesc" rows="2" placeholder="Brief description..."></textarea></div>
        <button type="submit" class="submit-btn" id="deptBtn">
          <div class="spinner" id="deptSpinner"></div>
          <i class="fas fa-plus" id="deptIcon"></i>
          <span id="deptBtnText">Add Department</span>
        </button>
      </form>
      <div class="msg-box" id="deptMessage"></div>
    </div>
  </div>

  <!-- PROJECT PANEL -->
  <div class="panel" id="panel-project">
    <div class="card">
      <div class="card-title"><i class="fas fa-project-diagram"></i> New Project</div>
      <div class="card-subtitle">Register a new project with a unique project number.</div>
      <form id="projectForm">
        <div class="field-row">
          <div class="field"><label>Project Name</label><input type="text" id="projectName" placeholder="e.g. Website Redesign" required /></div>
          <div class="field"><label>Project Number</label><input type="number" id="projectNumber" placeholder="e.g. 1042" required /></div>
        </div>
        <div class="field"><label>Assign Department</label><select id="projectDept"><option value="">‚Äî Select Department ‚Äî</option></select></div>
        <div class="field"><label>Description (optional)</label><textarea id="projectDesc" rows="2" placeholder="What is this project about?"></textarea></div>
        <button type="submit" class="submit-btn" id="projectBtn">
          <div class="spinner" id="projectSpinner"></div>
          <i class="fas fa-plus" id="projectIcon"></i>
          <span id="projectBtnText">Add Project</span>
        </button>
      </form>
      <div class="msg-box" id="projectMessage"></div>
    </div>
  </div>

  <!-- ADD USER PANEL -->
  <div class="panel" id="panel-user">
    <div class="card">
      <div class="card-title"><i class="fas fa-user-plus"></i> New User</div>
      <div class="card-subtitle">Create a system user and assign them a role and department.</div>
      <form id="userForm">
        <div class="field-row">
          <div class="field"><label>Username</label><input type="text" id="username" placeholder="e.g. jdoe" required /></div>
          <div class="field"><label>Full Name (optional)</label><input type="text" id="fullname" placeholder="e.g. John Doe" /></div>
        </div>
        <div class="field">
          <label>Password</label>
          <input type="password" id="password" placeholder="Enter a strong password" required oninput="checkPwStrength(this.value)" />
          <div class="pw-strength" id="pwStrength"></div>
          <div class="pw-hint" id="pwHint">Enter a password</div>
        </div>
        <div class="field"><label>Department</label><select id="userDept"><option value="">‚Äî Select Department ‚Äî</option></select></div>
        <div class="field">
          <label>Select Role</label>
          <div class="role-grid">
            <div class="role-card" data-role="admin" onclick="selectRole('admin',this)"><i class="fas fa-shield-alt"></i><span>Admin</span></div>
            <div class="role-card" data-role="manager" onclick="selectRole('manager',this)"><i class="fas fa-user-tie"></i><span>Manager</span></div>
            <div class="role-card" data-role="staff" onclick="selectRole('staff',this)"><i class="fas fa-user"></i><span>Staff</span></div>
          </div>
          <input type="hidden" id="role" required />
        </div>
        <button type="submit" class="submit-btn" id="userBtn">
          <div class="spinner" id="userSpinner"></div>
          <i class="fas fa-user-plus" id="userIcon"></i>
          <span id="userBtnText">Create User</span>
        </button>
      </form>
      <div class="msg-box" id="userMessage"></div>
    </div>
  </div>

  <!-- MANAGE USERS PANEL -->
  <div class="panel" id="panel-users-list">
    <div class="card card-wide">
      <div class="card-title"><i class="fas fa-users"></i> All Users</div>
      <div class="card-subtitle">View, edit roles, activate or deactivate system users.</div>
      <div class="search-bar">
        <input type="text" id="userSearch" placeholder="üîç  Search by username or role..." oninput="filterTable('userSearch','usersTable')" />
        <button class="submit-btn" style="width:auto;padding:10px 18px;" onclick="loadUsers()"><i class="fas fa-sync-alt"></i></button>
      </div>
      <div style="overflow-x:auto;">
        <table class="data-table" id="usersTable">
          <thead><tr><th>#</th><th>Username</th><th>Full Name</th><th>Role</th><th>Department</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="usersBody"><tr><td colspan="7"><div class="empty-state"><i class="fas fa-users"></i><p>Click refresh to load users</p></div></td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- DEPT LIST PANEL -->
  <div class="panel" id="panel-dept-list">
    <div class="card card-wide">
      <div class="card-title"><i class="fas fa-building"></i> All Departments</div>
      <div class="card-subtitle">View and delete existing departments.</div>
      <div class="search-bar">
        <input type="text" id="deptSearch" placeholder="üîç  Search departments..." oninput="filterTable('deptSearch','deptsTable')" />
        <button class="submit-btn" style="width:auto;padding:10px 18px;" onclick="loadDepts()"><i class="fas fa-sync-alt"></i></button>
      </div>
      <div style="overflow-x:auto;">
        <table class="data-table" id="deptsTable">
          <thead><tr><th>#</th><th>Department Name</th><th>Description</th><th>Actions</th></tr></thead>
          <tbody id="deptsBody"><tr><td colspan="4"><div class="empty-state"><i class="fas fa-building"></i><p>Click refresh to load departments</p></div></td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- PROJECT LIST PANEL -->
  <div class="panel" id="panel-proj-list">
    <div class="card card-wide">
      <div class="card-title"><i class="fas fa-tasks"></i> All Projects</div>
      <div class="card-subtitle">View and manage existing projects.</div>
      <div class="search-bar">
        <input type="text" id="projSearch" placeholder="üîç  Search projects..." oninput="filterTable('projSearch','projsTable')" />
        <button class="submit-btn" style="width:auto;padding:10px 18px;" onclick="loadProjects()"><i class="fas fa-sync-alt"></i></button>
      </div>
      <div style="overflow-x:auto;">
        <table class="data-table" id="projsTable">
          <thead><tr><th>#</th><th>Project Name</th><th>Number</th><th>Department</th><th>Actions</th></tr></thead>
          <tbody id="projsBody"><tr><td colspan="5"><div class="empty-state"><i class="fas fa-project-diagram"></i><p>Click refresh to load projects</p></div></td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- SETTINGS PANEL -->
  <div class="panel" id="panel-settings">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;max-width:860px;">
      <div class="card">
        <div class="card-title"><i class="fas fa-key"></i> Change Password</div>
        <div class="card-subtitle">Update your admin account password.</div>
        <form id="changePwForm">
          <div class="field"><label>Current Password</label><input type="password" id="currentPw" placeholder="Current password" required /></div>
          <div class="field"><label>New Password</label><input type="password" id="newPw" placeholder="New password" required oninput="checkPwStrength2(this.value)" /><div class="pw-strength" id="pwStrength2"></div></div>
          <div class="field"><label>Confirm New Password</label><input type="password" id="confirmPw" placeholder="Repeat new password" required /></div>
          <button type="submit" class="submit-btn" id="changePwBtn">
            <div class="spinner" id="changePwSpinner"></div>
            <i class="fas fa-lock" id="changePwIcon"></i>
            <span id="changePwText">Update Password</span>
          </button>
        </form>
        <div class="msg-box" id="changePwMsg"></div>
      </div>

      <div class="card">
        <div class="card-title"><i class="fas fa-info-circle"></i> System Info</div>
        <div class="card-subtitle">Current session and system details.</div>
        <div style="display:flex;flex-direction:column;gap:14px;margin-top:8px;">
          <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.06);"><span style="color:rgba(255,255,255,0.4);font-size:0.82rem;">Logged in as</span><span style="font-weight:600;font-size:0.88rem;" id="info-user">‚Äî</span></div>
          <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.06);"><span style="color:rgba(255,255,255,0.4);font-size:0.82rem;">Role</span><span style="font-weight:600;font-size:0.88rem;" id="info-role">‚Äî</span></div>
          <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.06);"><span style="color:rgba(255,255,255,0.4);font-size:0.82rem;">Session Started</span><span style="font-weight:600;font-size:0.88rem;" id="info-session">‚Äî</span></div>
          <div style="display:flex;justify-content:space-between;padding:10px 0;"><span style="color:rgba(255,255,255,0.4);font-size:0.82rem;">App Version</span><span style="font-weight:600;font-size:0.88rem;">v2.0.0</span></div>
        </div>
        <button class="submit-btn" style="margin-top:20px;background:rgba(239,68,68,0.15);color:#ef4444;" onclick="confirmLogout()"><i class="fas fa-sign-out-alt"></i> Sign Out</button>
      </div>

      <div class="card">
        <div class="card-title"><i class="fas fa-bell"></i> Notifications</div>
        <div class="card-subtitle">Control what alerts you receive.</div>
        <div style="display:flex;flex-direction:column;gap:16px;margin-top:8px;">
          <div style="display:flex;justify-content:space-between;align-items:center;"><div><div style="font-size:0.88rem;font-weight:600;">Low Stock Alerts</div><div style="font-size:0.75rem;color:rgba(255,255,255,0.35);">Notify when items run low</div></div><label class="toggle"><input type="checkbox" checked id="notif-lowstock"><span class="toggle-slider"></span></label></div>
          <div style="display:flex;justify-content:space-between;align-items:center;"><div><div style="font-size:0.88rem;font-weight:600;">New Order Alerts</div><div style="font-size:0.75rem;color:rgba(255,255,255,0.35);">Notify on pending orders</div></div><label class="toggle"><input type="checkbox" checked id="notif-orders"><span class="toggle-slider"></span></label></div>
          <div style="display:flex;justify-content:space-between;align-items:center;"><div><div style="font-size:0.88rem;font-weight:600;">New User Registrations</div><div style="font-size:0.75rem;color:rgba(255,255,255,0.35);">Notify when a user is added</div></div><label class="toggle"><input type="checkbox" id="notif-users"><span class="toggle-slider"></span></label></div>
        </div>
        <button class="submit-btn" style="margin-top:20px;" onclick="saveNotifPrefs()"><i class="fas fa-save"></i> Save Preferences</button>
        <div class="msg-box" id="notifMsg"></div>
      </div>

      <div class="card" style="border-color:rgba(239,68,68,0.2);">
        <div class="card-title" style="color:#ef4444;"><i class="fas fa-exclamation-triangle"></i> Danger Zone</div>
        <div class="card-subtitle">Irreversible actions. Proceed with caution.</div>
        <div style="display:flex;flex-direction:column;gap:12px;margin-top:8px;">
          <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:rgba(239,68,68,0.05);border:1px solid rgba(239,68,68,0.15);border-radius:10px;">
            <div><div style="font-size:0.85rem;font-weight:600;">Clear All Logs</div><div style="font-size:0.75rem;color:rgba(255,255,255,0.35);">Permanently delete all inventory logs</div></div>
            <button class="btn-danger" onclick="openModal('modal-clear-logs')">Clear</button>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:rgba(239,68,68,0.05);border:1px solid rgba(239,68,68,0.15);border-radius:10px;">
            <div><div style="font-size:0.85rem;font-weight:600;">Reset All Orders</div><div style="font-size:0.75rem;color:rgba(255,255,255,0.35);">Delete all order history permanently</div></div>
            <button class="btn-danger" onclick="openModal('modal-reset-orders')">Reset</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<a href="home.html" class="back-btn" title="Back to Dashboard"><i class="fas fa-arrow-left"></i></a>

<!-- MODALS -->
<div class="modal-overlay" id="modal-edit-user">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title"><i class="fas fa-user-edit" style="color:#4361ee;margin-right:8px;"></i>Edit User</div>
      <button class="modal-close" onclick="closeModal('modal-edit-user')"><i class="fas fa-times"></i></button>
    </div>
    <input type="hidden" id="editUserId" />
    <div class="field"><label>Username</label><input type="text" id="editUsername" /></div>
    <div class="field"><label>New Password <span style="color:rgba(255,255,255,0.3);font-weight:400;">(leave blank to keep)</span></label><input type="password" id="editPassword" placeholder="New password..." /></div>
    <div class="field"><label>Role</label><select id="editRole"><option value="admin">Admin</option><option value="manager">Manager</option><option value="staff">Staff</option></select></div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeModal('modal-edit-user')">Cancel</button>
      <button class="btn-confirm" onclick="saveUserEdit()">Save Changes</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-confirm-delete">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" style="color:#ef4444;"><i class="fas fa-trash" style="margin-right:8px;"></i>Confirm Delete</div>
      <button class="modal-close" onclick="closeModal('modal-confirm-delete')"><i class="fas fa-times"></i></button>
    </div>
    <p style="color:rgba(255,255,255,0.6);font-size:0.88rem;line-height:1.6;" id="deleteConfirmText">Are you sure you want to delete this item?</p>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeModal('modal-confirm-delete')">Cancel</button>
      <button class="btn-confirm red" id="deleteConfirmBtn">Delete</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-clear-logs">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" style="color:#ef4444;"><i class="fas fa-exclamation-triangle" style="margin-right:8px;"></i>Clear All Logs</div>
      <button class="modal-close" onclick="closeModal('modal-clear-logs')"><i class="fas fa-times"></i></button>
    </div>
    <p style="color:rgba(255,255,255,0.6);font-size:0.88rem;line-height:1.6;">This will permanently delete <strong style="color:#ef4444;">ALL inventory logs</strong>. Type <strong>CONFIRM</strong> to proceed.</p>
    <div class="field" style="margin-top:14px;"><input type="text" id="clearLogsConfirm" placeholder='Type "CONFIRM"' /></div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeModal('modal-clear-logs')">Cancel</button>
      <button class="btn-confirm red" onclick="clearLogs()">Clear Logs</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-reset-orders">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" style="color:#ef4444;"><i class="fas fa-exclamation-triangle" style="margin-right:8px;"></i>Reset All Orders</div>
      <button class="modal-close" onclick="closeModal('modal-reset-orders')"><i class="fas fa-times"></i></button>
    </div>
    <p style="color:rgba(255,255,255,0.6);font-size:0.88rem;line-height:1.6;">This will permanently delete <strong style="color:#ef4444;">ALL order history</strong>. Type <strong>CONFIRM</strong> to proceed.</p>
    <div class="field" style="margin-top:14px;"><input type="text" id="resetOrdersConfirm" placeholder='Type "CONFIRM"' /></div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeModal('modal-reset-orders')">Cancel</button>
      <button class="btn-confirm red" onclick="resetOrders()">Reset Orders</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-logout">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title"><i class="fas fa-sign-out-alt" style="color:#4361ee;margin-right:8px;"></i>Sign Out</div>
      <button class="modal-close" onclick="closeModal('modal-logout')"><i class="fas fa-times"></i></button>
    </div>
    <p style="color:rgba(255,255,255,0.6);font-size:0.88rem;">Are you sure you want to sign out?</p>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeModal('modal-logout')">Stay</button>
      <button class="btn-confirm red" onclick="doLogout()">Sign Out</button>
    </div>
  </div>
</div>

<script>
  const adminRole    = localStorage.getItem("user_role") || sessionStorage.getItem("user_role");
  const sessionToken = sessionStorage.getItem("INVENTORY_SESSION") || localStorage.getItem("INVENTORY_SESSION");
  const currentUser  = localStorage.getItem("username") || sessionStorage.getItem("username") || "Admin";

  const API = {
    DEPT:        "http://localhost/inventory_app/api/endpoints/reports.php?resource=department_name",
    USER:        "http://localhost/inventory_app/api/endpoints/register.php",
    PROJECT:     "http://localhost/inventory_app/api/endpoints/project.php",
    USERS_LIST:  "http://localhost/inventory_app/api/endpoints/register.php?resource=list",
    DEPTS_LIST:  "http://localhost/inventory_app/api/endpoints/reports.php?resource=departments",
    PROJ_LIST:   "http://localhost/inventory_app/api/endpoints/project.php?resource=list",
    DELETE_USER: "http://localhost/inventory_app/api/endpoints/register.php?resource=delete&id=",
    DELETE_DEPT: "http://localhost/inventory_app/api/endpoints/reports.php?resource=delete_dept&id=",
    DELETE_PROJ: "http://localhost/inventory_app/api/endpoints/project.php?resource=delete&id=",
    CHANGE_PW:   "http://localhost/inventory_app/api/endpoints/auth.php?resource=change_password",
    CLEAR_LOGS:  "http://localhost/inventory_app/api/endpoints/get_logs.php?resource=clear",
    RESET_ORDERS:"http://localhost/inventory_app/api/endpoints/orders.php?resource=reset",
    EDIT_USER:   "http://localhost/inventory_app/api/endpoints/register.php?resource=update",
    STATS:       "http://localhost/inventory_app/api/endpoints/register.php?resource=stats",
  };

  const headers = () => ({
    "Content-Type": "application/json",
    "Authorization": `Bearer ${sessionToken}`
  });

  // ‚îÄ‚îÄ SESSION CHECK ‚îÄ‚îÄ
  document.addEventListener('DOMContentLoaded', () => {
    if (!localStorage.getItem('user_id') && !sessionStorage.getItem('user_id')) {
      window.location.href = 'login.html'; return;
    }
    // Admin-only guard
    if (adminRole && adminRole !== 'admin') {
      alert('Access denied. Admins only.');
      window.location.href = 'home.html'; return;
    }
    document.getElementById('info-user').textContent    = currentUser;
    document.getElementById('info-role').textContent    = adminRole || '‚Äî';
    document.getElementById('info-session').textContent = new Date().toLocaleString();
    loadDeptDropdowns();
    loadNotifPrefs();
    updateStats();
  });

  // ‚îÄ‚îÄ TAB SWITCH ‚îÄ‚îÄ
  function switchTab(name, btn) {
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('panel-' + name).classList.add('active');
    btn.classList.add('active');
  }

  // ‚îÄ‚îÄ ROLE SELECT ‚îÄ‚îÄ
  function selectRole(role, el) {
    document.querySelectorAll('.role-card').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    document.getElementById('role').value = role;
  }

  // ‚îÄ‚îÄ MSG ‚îÄ‚îÄ
  function showMsg(id, text, type) {
    const el = document.getElementById(id);
    el.className = 'msg-box show ' + type;
    const icons = { success: 'fa-check-circle', error: 'fa-times-circle', loading: 'fa-circle-notch fa-spin' };
    el.innerHTML = `<i class="fas ${icons[type] || 'fa-info-circle'}"></i> ${text}`;
    if (type !== 'loading') setTimeout(() => el.classList.remove('show'), 4500);
  }

  // ‚îÄ‚îÄ LOADING STATE ‚îÄ‚îÄ
  function setLoading(btnId, spinnerId, iconId, textId, loading, label) {
    document.getElementById(btnId).disabled                = loading;
    document.getElementById(spinnerId).style.display       = loading ? 'block' : 'none';
    document.getElementById(iconId).style.display          = loading ? 'none'  : 'inline';
    document.getElementById(textId).textContent            = loading ? 'Saving...' : label;
  }

  // ‚îÄ‚îÄ PASSWORD STRENGTH ‚îÄ‚îÄ
  function checkPwStrength(val) {
    const bar  = document.getElementById('pwStrength');
    const hint = document.getElementById('pwHint');
    if (!val) { bar.className = 'pw-strength'; hint.textContent = 'Enter a password'; return; }
    const strong = val.length >= 8 && /[A-Z]/.test(val) && /[0-9]/.test(val) && /[^A-Za-z0-9]/.test(val);
    const medium = val.length >= 6 && (/[A-Z]/.test(val) || /[0-9]/.test(val));
    if (strong)       { bar.className = 'pw-strength strong'; hint.textContent = '‚úî Strong password'; }
    else if (medium)  { bar.className = 'pw-strength medium'; hint.textContent = '‚ö† Medium ‚Äî add symbols or uppercase'; }
    else              { bar.className = 'pw-strength weak';   hint.textContent = '‚úó Weak ‚Äî too short or simple'; }
  }

  function checkPwStrength2(val) {
    const bar = document.getElementById('pwStrength2');
    if (!val) { bar.className = 'pw-strength'; return; }
    const strong = val.length >= 8 && /[A-Z]/.test(val) && /[0-9]/.test(val);
    const medium = val.length >= 6;
    bar.className = 'pw-strength ' + (strong ? 'strong' : medium ? 'medium' : 'weak');
  }

  // ‚îÄ‚îÄ MODAL HELPERS ‚îÄ‚îÄ
  function openModal(id)  { document.getElementById(id).classList.add('show'); }
  function closeModal(id) { document.getElementById(id).classList.remove('show'); }

  // Close modal on overlay click
  document.querySelectorAll('.modal-overlay').forEach(overlay => {
    overlay.addEventListener('click', e => { if (e.target === overlay) overlay.classList.remove('show'); });
  });

  // ‚îÄ‚îÄ STATS ‚îÄ‚îÄ
  async function updateStats() {
    try {
      const res  = await fetch(API.USERS_LIST, { headers: headers() });
      const data = await res.json();
      const users = data.data || [];
      document.getElementById('stat-users').textContent  = users.length;
      document.getElementById('stat-admins').textContent = users.filter(u => u.role === 'admin').length;
    } catch {}
    try {
      const res  = await fetch(API.DEPTS_LIST, { headers: headers() });
      const data = await res.json();
      document.getElementById('stat-depts').textContent = (data.data || []).length;
    } catch {}
    try {
      const res  = await fetch(API.PROJ_LIST, { headers: headers() });
      const data = await res.json();
      document.getElementById('stat-projects').textContent = (data.data || []).length;
    } catch {}
  }

  // ‚îÄ‚îÄ LOAD DEPT DROPDOWNS ‚îÄ‚îÄ
  async function loadDeptDropdowns() {
    try {
      const res   = await fetch(API.DEPTS_LIST, { headers: headers() });
      const data  = await res.json();
      const depts = data.data || [];
      ['projectDept','userDept'].forEach(id => {
        const sel = document.getElementById(id);
        if (!sel) return;
        sel.innerHTML = '<option value="">‚Äî Select Department ‚Äî</option>';
        depts.forEach(d => {
          sel.innerHTML += `<option value="${d.department_id}">${d.department_name}</option>`;
        });
      });
      document.getElementById('stat-depts').textContent = depts.length;
    } catch {}
  }

  // ‚îÄ‚îÄ ADD DEPARTMENT ‚îÄ‚îÄ
  document.getElementById("departmentForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const name = document.getElementById("departmentName").value.trim();
    if (!name) return showMsg("deptMessage", "Department name is required.", "error");
    setLoading("deptBtn","deptSpinner","deptIcon","deptBtnText", true);
    showMsg("deptMessage", "Saving...", "loading");
    try {
      const res  = await fetch(API.DEPT, { method:"POST", headers: headers(), body: JSON.stringify({ department_name: name }) });
      const data = await res.json();
      if (res.ok) {
        showMsg("deptMessage", "Department added successfully!", "success");
        e.target.reset();
        loadDeptDropdowns();
        updateStats();
      } else showMsg("deptMessage", data.message || "Failed.", "error");
    } catch { showMsg("deptMessage", "Network error.", "error"); }
    finally { setLoading("deptBtn","deptSpinner","deptIcon","deptBtnText", false, "Add Department"); }
  });

  // ‚îÄ‚îÄ ADD PROJECT ‚îÄ‚îÄ
  document.getElementById("projectForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const name   = document.getElementById("projectName").value.trim();
    const number = document.getElementById("projectNumber").value.trim();
    const dept   = document.getElementById("projectDept").value;
    const desc   = document.getElementById("projectDesc").value.trim();
    if (!name || !number) return showMsg("projectMessage", "Name and number are required.", "error");
    setLoading("projectBtn","projectSpinner","projectIcon","projectBtnText", true);
    showMsg("projectMessage", "Saving...", "loading");
    try {
      const res  = await fetch(API.PROJECT, {
        method: "POST", credentials: "include", headers: headers(),
        body: JSON.stringify({ project_name: name, project_number: number, department_id: dept, description: desc })
      });
      const data = await res.json();
      if (res.ok) {
        showMsg("projectMessage", "Project added successfully!", "success");
        e.target.reset();
        updateStats();
      } else showMsg("projectMessage", data.message || "Failed.", "error");
    } catch { showMsg("projectMessage", "Network error.", "error"); }
    finally { setLoading("projectBtn","projectSpinner","projectIcon","projectBtnText", false, "Add Project"); }
  });

  // ‚îÄ‚îÄ ADD USER ‚îÄ‚îÄ
  document.getElementById("userForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value.trim();
    const role     = document.getElementById("role").value;
    const fullname = document.getElementById("fullname").value.trim();
    const dept     = document.getElementById("userDept").value;
    if (!username || !password || !role) return showMsg("userMessage", "Username, password and role are required.", "error");
    setLoading("userBtn","userSpinner","userIcon","userBtnText", true);
    showMsg("userMessage", "Creating user...", "loading");
    try {
      const res  = await fetch(API.USER, {
        method: "POST", headers: headers(),
        body: JSON.stringify({ username, password, role, full_name: fullname, department_id: dept })
      });
      const data = await res.json();
      if (res.ok) {
        showMsg("userMessage", `User "${username}" created successfully!`, "success");
        e.target.reset();
        document.querySelectorAll('.role-card').forEach(c => c.classList.remove('selected'));
        document.getElementById('role').value = '';
        updateStats();
      } else showMsg("userMessage", data.message || "Failed.", "error");
    } catch { showMsg("userMessage", "Network error.", "error"); }
    finally { setLoading("userBtn","userSpinner","userIcon","userBtnText", false, "Create User"); }
  });

  // ‚îÄ‚îÄ LOAD USERS ‚îÄ‚îÄ
  async function loadUsers() {
    const tbody = document.getElementById('usersBody');
    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:20px;color:rgba(255,255,255,0.3);"><i class="fas fa-circle-notch fa-spin"></i> Loading...</td></tr>`;
    try {
      const res   = await fetch(API.USERS_LIST, { headers: headers() });
      const data  = await res.json();
      const users = data.data || [];
      document.getElementById('stat-users').textContent  = users.length;
      document.getElementById('stat-admins').textContent = users.filter(u => u.role === 'admin').length;
      if (!users.length) {
        tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><i class="fas fa-users"></i><p>No users found</p></div></td></tr>`;
        return;
      }
      tbody.innerHTML = users.map((u, i) => `
  <tr>
    <td style="color:rgba(255,255,255,0.3);">${i + 1}</td>
    <td><strong>${escHtml(u.username)}</strong></td>
    <td>${escHtml(u.full_name || '‚Äî')}</td>
    <td><span class="badge badge-${u.role}">${u.role}</span></td>
    <td>${escHtml(u.department_name || '‚Äî')}</td>
    <td>
      <span class="badge ${u.is_active == 1 ? 'badge-active' : 'badge-inactive'}">
        ${u.is_active == 1 ? '‚óè Active' : '‚óè Inactive'}
      </span>
    </td>
    <td style="display:flex;gap:6px;">
      <button class="btn-sm btn-edit"
        onclick="openEditUser(${u.user_id}, '${escHtml(u.username)}', '${escHtml(u.full_name || '')}', '${u.role}', '${u.department_id || ''}', ${u.is_active})">
        <i class="fas fa-edit"></i>
      </button>
      <button class="btn-sm btn-delete"
        onclick="deleteUser(${u.user_id}, '${escHtml(u.username)}')">
        <i class="fas fa-trash"></i>
      </button>
    </td>
  </tr>
`).join('');
    } catch {
      tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:20px;color:rgba(255,255,255,0.3);">Failed to load users</td></tr>`;
    }
  }

  // ‚îÄ‚îÄ OPEN EDIT USER MODAL ‚îÄ‚îÄ
  function openEditUser(id, username, fullname, role, deptId, isActive) {
    document.getElementById('editUserId').value = id;
    document.getElementById('editUsername').value = username;
    document.getElementById('editPassword').value = '';
    document.getElementById('editRole').value = role;
    loadDeptDropdowns().then(() => {
      const deptSelect = document.getElementById('editDept');
      if (deptSelect) deptSelect.value = deptId || '';
    });
    const statusBadge = document.getElementById('editStatus');
    if (statusBadge) {
      statusBadge.textContent = isActive == 1 ? '‚óè Active' : '‚óè Inactive';
      statusBadge.className = 'badge ' + (isActive == 1 ? 'badge-active' : 'badge-inactive');
    }
    openModal('modal-edit-user');


  }

  // ‚îÄ‚îÄ SAVE USER EDIT ‚îÄ‚îÄ
 async function saveUserUpdate() {
  const id       = document.getElementById('editUserId').value;
  const fullname = document.getElementById('editFullname').value.trim();
  const role     = document.getElementById('editRole').value;
  const dept     = document.getElementById('editDept').value;
  const active   = document.getElementById('editActive').checked ? 1 : 0;

  try {
    const res = await fetch(API.EDIT_USER, {
      method: "PUT",
      headers: headers(),
      body: JSON.stringify({
        user_id: id,
        full_name: fullname,
        role,
        department_id: dept,
        is_active: active
      })
    });

    const data = await res.json();

    if (res.ok) {
      showMsg("userMessage", "User updated successfully!", "success");
      closeModal('editUserModal');
      loadUsers();
      updateStats();
    } else {
      showMsg("userMessage", data.message || "Update failed.", "error");
    }

  } catch {
    showMsg("userMessage", "Network error.", "error");
  }
}

  // ‚îÄ‚îÄ DELETE USER ‚îÄ‚îÄ
  function deleteUser(id, username) {
    document.getElementById('deleteConfirmText').textContent = `Are you sure you want to delete user "${username}"?`;
    const confirmBtn = document.getElementById('deleteConfirmBtn');
    confirmBtn.onclick = async () => {
      try {
        const res = await fetch(API.DELETE_USER + id, { method: "DELETE", headers: headers() });
        const data = await res.json();
        if (res.ok) {
          showMsg("userMessage", `User "${username}" deleted successfully!`, "success");
          loadUsers();
          updateStats();
        } else {
          showMsg("userMessage", data.message || "Delete failed.", "error");
        }
      } catch {
        showMsg("userMessage", "Network error.", "error");
      }
      closeModal('modal-confirm-delete');
    };
    openModal('modal-confirm-delete');
  }

  // ‚îÄ‚îÄ LOAD DEPARTMENTS ‚îÄ‚îÄ
//   async function loadDepts() {
//     const tbody = document.getElementById('deptsBody');
//     tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;padding:20px;color:rgba(255,255,255,0.3);"><i class="fas fa-circle-notch fa-spin"></i> Loading...</td></tr>`;
//     try {
//       const res   = await fetch(API.DEPTS_LIST, { headers: headers() });
//       const data  = await res.json();
//       const depts = data.data || [];
//       document.getElementById('stat-depts').textContent = depts.length;
//       if (!depts.length) {
//         tbody.innerHTML = `<tr><td colspan="4"><div class="empty-state"><i class="fas fa-building"></i><p>No departments found</p></div></td></tr>`;
//         return;
//       }
//       tbody.innerHTML = depts.map((d, i) => `
//   <tr>
//     <td style="color:rgba(255,255,255,0.3);">${i + 1}</td>
//     <td><strong>${escHtml(d.department_name)}</strong></td>
//     <td>${escHtml(d.description || '‚Äî')}</td>
//     <td style="display:flex;gap:6px;">
//       <button class="btn-sm btn-delete"
//         onclick="deleteDept(${d.department_id}, '${escHtml(d.department_name)}')">
//         <i class="fas fa-trash"></i>    
//       </button>
//     </td>
//   </tr>
// `).join('');
//     } catch {
//       tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;padding:20px;color:rgba(255,255,255,0.3);">Failed to load departments</td></tr>`;
//     }
//   } 


        async function loadDepts() {
    const res = await fetch('http://localhost/inventory_app/api/endpoints/reports.php?resource=get_departments');
    const depts = await res.json();
    depts.forEach(d => deptSelect.innerHTML += `<option value="${d.department_id}">${d.department_name}</option>`);
}
//////////////// LOAD PROJECTS FOR DROPDOWN
    async function loadprojects() {
    const res = await fetch('http://localhost/inventory_app/api/endpoints/project.php',
        {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        }
    );
   const projects = await res.json();
    const projectSelect = document.getElementById("projectSelect");
    projects.forEach(p => projectSelect.innerHTML += `<option value="${p.project_number}">${p.project_name}</option>`);
}
</script>
</body>
</html>  
